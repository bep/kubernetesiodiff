<html><head></head><body>
<h1>
  Certificate Management with kubeadm
</h1>
<p>
  <a href="https://github.com/kubernetes/website/edit/master/content/en/docs/tasks/administer-cluster/kubeadm/kubeadm-certs.md" id="editPageButton" target="_blank">
    Edit This Page
  </a>
</p>
<h1>
  Certificate Management with kubeadm
</h1>
<div style="margin-top: 10px; margin-bottom: 10px;">
<p data-diff="">
  <b>
    FEATURE STATE:
  </b>
  <code>
    Kubernetes v1.15
  </code>
</p>
<p>
  <a href="#" id="feature-state-dialog-link" class="ui-state-default ui-corner-all">
    <span class="ui-icon ui-icon-newwin"></span>
    stable
  </a>
</p>
<div id="feature-state-dialog" class="ui-dialog-content" title="stable">
  <p>
    This feature is
    <em>
      stable
    </em>
    , meaning:
  </p>
  <ul>
    <li>
      The version name is vX where X is an integer.
    </li>
    <li>
      Stable versions of features will appear in released software for many subsequent versions.
    </li>
  </ul>
</div>
<script>
  $(function(){
  <pre><code>$( &quot;#feature-state-dialog&quot; ).dialog({
  autoOpen: false,
  width: &quot;600&quot;,
  buttons: [
  {
  text: &quot;Ok&quot;,
  click: function() {
  $( this ).dialog( &quot;close&quot; );
  }
  }
  ]
  });


  $( &quot;#feature-state-dialog-link&quot; ).click(function( event ) {
  $( &quot;#feature-state-dialog&quot; ).dialog( &quot;open&quot; );
  event.preventDefault();
  });</code></pre>
  <p>});
</script>
<p>
  Client certificates generated by
  <a href="/docs/reference/setup-tools/kubeadm/kubeadm/">
    kubeadm
  </a>
  expire after 1 year. This page explains how to manage certificate renewals with kubeadm.
</p>
<ul id="markdown-toc">
  <li>
    <a href="#before-you-begin">
      Before you begin
    </a>
  </li>
  <li>
    <a href="#custom-certificates">
      Using custom certificates
    </a>
  </li>
  <li>
    <a href="#external-ca-mode">
      External CA mode
    </a>
  </li>
  <li>
    <a href="#check-certificate-expiration">
      Check certificate expiration
    </a>
  </li>
  <li>
    <a href="#automatic-certificate-renewal">
      Automatic certificate renewal
    </a>
  </li>
  <li>
    <a href="#manual-certificate-renewal">
      Manual certificate renewal
    </a>
  </li>
  <li>
    <a href="#renew-certificates-with-the-kubernetes-certificates-api">
      Renew certificates with the Kubernetes certificates API
    </a>
  </li>
  <li>
    <a href="#renew-certificates-with-external-ca">
      Renew certificates with external CA
    </a>
  </li>
</ul>
<h2 id="before-you-begin">
  Before you begin
</h2>
<p>
  You should be familiar with
  <a href="/docs/setup/best-practices/certificates/">
    PKI certificates and requirements in Kubernetes
  </a>
  .
</p>
<h2 id="custom-certificates">
  Using custom certificates
</h2>
<p>
  By default, kubeadm generates all the certificates needed for a cluster to run.
  You can override this behavior by providing your own certificates.
</p>
<p>
  To do so, you must place them in whatever directory is specified by the
  <code>
    --cert-dir
  </code>
  flag or the
  <code>
    certificatesDir
  </code>
  field of kubeadm’s
  <code>
    ClusterConfiguration
  </code>
  .
  By default this is
  <code>
    /etc/kubernetes/pki
  </code>
  .
</p>
<p>
  If a given certificate and private key pair exists before running
  <code>
    kubeadm init
  </code>
  ,
  kubeadm does not overwrite them. This means you can, for example, copy an existing
  CA into
  <code>
    /etc/kubernetes/pki/ca.crt
  </code>
  and
  <code>
    /etc/kubernetes/pki/ca.key
  </code>
  ,
  and kubeadm will use this CA for signing the rest of the certificates.
</p>
<h2 id="external-ca-mode">
  External CA mode
</h2>
<p>
  It is also possible to provide just the
  <code>
    ca.crt
  </code>
  file and not the
  <code>
    ca.key
  </code>
  file (this is only available for the root CA file, not other cert pairs).
  If all other certificates and kubeconfig files are in place, kubeadm recognizes
  this condition and activates the “External CA” mode. kubeadm will proceed without the
  CA key on disk.
</p>
<p>
  Instead, run the controller-manager standalone with
  <code>
    --controllers=csrsigner
  </code>
  and
  point to the CA certificate and key.
</p>
<p>
  <a href="/docs/setup/best-practices/certificates/">
    PKI certificates and requirements
  </a>
  includes guidance on
  setting up a cluster to use an external CA.
</p>
<h2 id="check-certificate-expiration">
  Check certificate expiration
</h2>
<p>
  You can use the
  <code>
    check-expiration
  </code>
  subcommand to check when certificates expire:
</p><pre><code>kubeadm alpha certs check-expiration</code></pre>
<p>
  The output is similar to this:
</p><pre><code>CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
admin.conf                 Dec 30, 2020 23:36 UTC   364d                                    no
apiserver                  Dec 30, 2020 23:36 UTC   364d            ca                      no
apiserver-etcd-client      Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
apiserver-kubelet-client   Dec 30, 2020 23:36 UTC   364d            ca                      no
controller-manager.conf    Dec 30, 2020 23:36 UTC   364d                                    no
etcd-healthcheck-client    Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
etcd-peer                  Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
etcd-server                Dec 30, 2020 23:36 UTC   364d            etcd-ca                 no
front-proxy-client         Dec 30, 2020 23:36 UTC   364d            front-proxy-ca          no
scheduler.conf             Dec 30, 2020 23:36 UTC   364d                                    no

CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
ca                      Dec 28, 2029 23:36 UTC   9y              no
etcd-ca                 Dec 28, 2029 23:36 UTC   9y              no
front-proxy-ca          Dec 28, 2029 23:36 UTC   9y              no</code></pre>
<p>
  The command shows expiration/residual time for the client certificates in the
  <code>
    /etc/kubernetes/pki
  </code>
  folder and for the client certificate embedded in the KUBECONFIG files used by kubeadm (
  <code>
    admin.conf
  </code>
  ,
  <code>
    controller-manager.conf
  </code>
  and
  <code>
    scheduler.conf
  </code>
  ).
</p>
<p>
  Additionally, kubeadm informs the user if the certificate is externally managed; in this case, the user should take care of managing certificate renewal manually/using other tools.
</p>
<blockquote class="warning">
  <div>
    <strong>
      Warning:
    </strong>
    <code>
      kubeadm
    </code>
    cannot manage certificates signed by an external CA.
  </div>
</blockquote>
<blockquote class="note">
  <div>
    <strong>
      Note:
    </strong>
    <code>
      kubelet.conf
    </code>
    is not included in the list above because kubeadm configures kubelet for automatic certificate renewal.
  </div>
</blockquote>
<blockquote class="warning">
  <div>
    <strong>
      Warning:
    </strong>
    <p>
      On nodes created with
      <code>
        kubeadm init
      </code>
      , prior to kubeadm version 1.17, there is a
      <a href="https://github.com/kubernetes/kubeadm/issues/1753">
        bug
      </a>
      where you manually have to modify the contents of
      <code>
        kubelet.conf
      </code>
      . After
      <code>
        kubeadm init
      </code>
      finishes, you should update
      <code>
        kubelet.conf
      </code>
      to point to the
      rotated kubelet client certificates, by replacing
      <code>
        client-certificate-data
      </code>
      and
      <code>
        client-key-data
      </code>
      with:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#a2f;font-weight:bold">client-certificate</span>:<span style="color:#bbb"> </span>/var/lib/kubelet/pki/kubelet-client-current.pem<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">client-key</span>:<span style="color:#bbb"> </span>/var/lib/kubelet/pki/kubelet-client-current.pem<span style="color:#bbb">
</span></code></pre>
    </div>
  </div>
</blockquote>
<h2 id="automatic-certificate-renewal">
  Automatic certificate renewal
</h2>
<p>
  kubeadm renews all the certificates during control plane
  <a href="/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/">
    upgrade
  </a>
  .
</p>
<p>
  This feature is designed for addressing the simplest use cases;
  if you don’t have specific requirements on certificate renewal and perform Kubernetes version upgrades regularly (less than 1 year in between each upgrade), kubeadm will take care of keeping your cluster up to date and reasonably secure.
</p>
<blockquote class="note">
  <div>
    <strong>
      Note:
    </strong>
    It is a best practice to upgrade your cluster frequently in order to stay secure.
  </div>
</blockquote>
<p>
  If you have more complex requirements for certificate renewal, you can opt out from the default behavior by passing
  <code>
    --certificate-renewal=false
  </code>
  to
  <code>
    kubeadm upgrade apply
  </code>
  or to
  <code>
    kubeadm upgrade node
  </code>
  .
</p>
<blockquote class="warning">
  <div>
    <strong>
      Warning:
    </strong>
    Prior to kubeadm version 1.17 there is a
    <a href="https://github.com/kubernetes/kubeadm/issues/1818">
      bug
    </a>
    where the default value for
    <code>
      --certificate-renewal
    </code>
    is
    <code>
      false
    </code>
    for the
    <code>
      kubeadm upgrade node
    </code>
    command. In that case, you should explicitly set
    <code>
      --certificate-renewal=true
    </code>
    .
  </div>
</blockquote>
<h2 id="manual-certificate-renewal">
  Manual certificate renewal
</h2>
<p>
  You can renew your certificates manually at any time with the
  <code>
    kubeadm alpha certs renew
  </code>
  command.
</p>
<p>
  This command performs the renewal using CA (or front-proxy-CA) certificate and key stored in
  <code>
    /etc/kubernetes/pki
  </code>
  .
</p>
<blockquote class="warning">
  <div>
    <strong>
      Warning:
    </strong>
    If you are running an HA cluster, this command needs to be executed on all the control-plane nodes.
  </div>
</blockquote>
<blockquote class="note">
  <div>
    <strong>
      Note:
    </strong>
    <code>
      alpha certs renew
    </code>
    uses the existing certificates as the authoritative source for attributes (Common Name, Organization, SAN, etc.) instead of the kubeadm-config ConfigMap. It is strongly recommended to keep them both in sync.
  </div>
</blockquote>
<p>
  <code>
    kubeadm alpha certs renew
  </code>
  provides the following options:
</p>
<p>
  The Kubernetes certificates normally reach their expiration date after one year.
</p>
<ul>
  <li>
    <p>
      <code>
        --csr-only
      </code>
      can be used to renew certificates with an external CA by generating certificate signing requests (without actually renewing certificates in place); see next paragraph for more information.
    </p>
  </li>
  <li>
    <p>
      It’s also possible to renew a single certificate instead of all.
    </p>
  </li>
</ul>
<h2 id="renew-certificates-with-the-kubernetes-certificates-api">
  Renew certificates with the Kubernetes certificates API
</h2>
<p>
  This section provide more details about how to execute manual certificate renewal using the Kubernetes certificates API.
</p>
<blockquote class="caution">
  <div>
    <strong>
      Caution:
    </strong>
    These are advanced topics for users who need to integrate their organization’s certificate infrastructure into a kubeadm-built cluster. If the default kubeadm configuration satisfies your needs, you should let kubeadm manage certificates instead.
  </div>
</blockquote>
<h3 id="set-up-a-signer">
  Set up a signer
</h3>
<p>
  The Kubernetes Certificate Authority does not work out of the box.
  You can configure an external signer such as
  <a href="https://docs.cert-manager.io/en/latest/tasks/issuers/setup-ca.html">
    cert-manager
  </a>
  , or you can use the built-in signer.
</p>
<p>
  The built-in signer is part of
  <a href="/docs/reference/command-line-tools-reference/kube-controller-manager/">
    <code>
      kube-controller-manager
    </code>
  </a>
  .
</p>
<p>
  To activate the built-in signer, you must pass the
  <code>
    --cluster-signing-cert-file
  </code>
  and
  <code>
    --cluster-signing-key-file
  </code>
  flags.
</p>
<p>
  If you’re creating a new cluster, you can use a kubeadm
  <a href="https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2">
    configuration file
  </a>
  :
</p>
<div class="highlight">
  <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#a2f;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>kubeadm.k8s.io/v1beta2<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>ClusterConfiguration<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">controllerManager</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">extraArgs</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">cluster-signing-cert-file</span>:<span style="color:#bbb"> </span>/etc/kubernetes/pki/ca.crt<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">cluster-signing-key-file</span>:<span style="color:#bbb"> </span>/etc/kubernetes/pki/ca.key<span style="color:#bbb">
</span></code></pre>
</div>
<h3 id="create-certificate-signing-requests-csr">
  Create certificate signing requests (CSR)
</h3>
<p>
  You can create the certificate signing requests for the Kubernetes certificates API with
  <code>
    kubeadm alpha certs renew --use-api
  </code>
  .
</p>
<p>
  If you set up an external signer such as
  <a href="https://github.com/jetstack/cert-manager">
    cert-manager
  </a>
  , certificate signing requests (CSRs) are automatically approved.
  Otherwise, you must manually approve certificates with the
  <a href="/docs/setup/best-practices/certificates/">
    <code>
      kubectl certificate
    </code>
  </a>
  command.
  The following kubeadm command outputs the name of the certificate to approve, then blocks and waits for approval to occur:
</p>
<div class="highlight">
  <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sudo kubeadm alpha certs renew apiserver --use-api &amp;</code></pre>
</div>
<p>
  The output is similar to this:
</p><pre><code>[1] 2890
[certs] certificate request &#34;kubeadm-cert-kube-apiserver-ld526&#34; created</code></pre>
<h3 id="approve-certificate-signing-requests-csr">
  Approve certificate signing requests (CSR)
</h3>
<p>
  If you set up an external signer, certificate signing requests (CSRs) are automatically approved.
</p>
<p>
  Otherwise, you must manually approve certificates with the
  <a href="/docs/setup/best-practices/certificates/">
    <code>
      kubectl certificate
    </code>
  </a>
  command. e.g.
</p>
<div class="highlight">
  <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl certificate approve kubeadm-cert-kube-apiserver-ld526</code></pre>
</div>
<p>
  The output is similar to this:
</p>
<div class="highlight">
  <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">certificatesigningrequest.certificates.k8s.io/kubeadm-cert-kube-apiserver-ld526 approved</code></pre>
</div>
<p>
  You can view a list of pending certificates with
  <code>
    kubectl get csr
  </code>
  .
</p>
<h2 id="renew-certificates-with-external-ca">
  Renew certificates with external CA
</h2>
<p>
  This section provide more details about how to execute manual certificate renewal using an external CA.
</p>
<p>
  To better integrate with external CAs, kubeadm can also produce certificate signing requests (CSRs).
  A CSR represents a request to a CA for a signed certificate for a client.
  In kubeadm terms, any certificate that would normally be signed by an on-disk CA can be produced as a CSR instead. A CA, however, cannot be produced as a CSR.
</p>
<h3 id="create-certificate-signing-requests-csr-1">
  Create certificate signing requests (CSR)
</h3>
<p>
  You can create certificate signing requests with
  <code>
    kubeadm alpha certs renew --csr-only
  </code>
  .
</p>
<p>
  Both the CSR and the accompanying private key are given in the output.
  You can pass in a directory with
  <code>
    --csr-dir
  </code>
  to output the CSRs to the specified location.
  If
  <code>
    --csr-dir
  </code>
  is not specified, the default certificate directory (
  <code>
    /etc/kubernetes/pki
  </code>
  ) is used.
</p>
<p>
  Certificates can be renewed with
  <code>
    kubeadm alpha certs renew --csr-only
  </code>
  .
  As with
  <code>
    kubeadm init
  </code>
  , an output directory can be specified with the
  <code>
    --csr-dir
  </code>
  flag.
</p>
<p>
  A CSR contains a certificate’s name, domains, and IPs, but it does not specify usages.
  It is the responsibility of the CA to specify
  <a href="/docs/setup/best-practices/certificates/#all-certificates">
    the correct cert usages
  </a>
  when issuing a certificate.
</p>
<ul>
  <li>
    In
    <code>
      openssl
    </code>
    this is done with the
    <a href="https://superuser.com/questions/738612/openssl-ca-keyusage-extension">
      <code>
        openssl ca
      </code>
      command
    </a>
    .
  </li>
  <li>
    In
    <code>
      cfssl
    </code>
    you specify
    <a href="https://github.com/cloudflare/cfssl/blob/master/doc/cmd/cfssl.txt#L170">
      usages in the config file
    </a>
  </li>
</ul>
<p>
  After a certificate is signed using your preferred method, the certificate and the private key must be copied to the PKI directory (by default
  <code>
    /etc/kubernetes/pki
  </code>
  ).
</p></div></body></html>