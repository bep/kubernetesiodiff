<html>
  <body>
    <h1>
      Configure Liveness, Readiness and Startup Probes
    </h1>
    <p>
      <a href="https://github.com/kubernetes/website/edit/master/content/en/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes.md" id="editPageButton" target="_blank">
        Edit This Page
      </a>
    </p>
    <h1>
      Configure Liveness, Readiness and Startup Probes
    </h1>
    <p>
      This page shows how to configure liveness, readiness and startup probes for containers.
    </p>
    <p>
      The
      <a href="/docs/admin/kubelet/">
        kubelet
      </a>
      uses liveness probes to know when to
      restart a container. For example, liveness probes could catch a deadlock,
      where an application is running, but unable to make progress. Restarting a
      container in such a state can help to make the application more available
      despite bugs.
    </p>
    <p>
      The kubelet uses readiness probes to know when a container is ready to start
      accepting traffic. A Pod is considered ready when all of its containers are ready.
      One use of this signal is to control which Pods are used as backends for Services.
      When a Pod is not ready, it is removed from Service load balancers.
    </p>
    <p>
      The kubelet uses startup probes to know when a container application has started.
      If such a probe is configured, it disables liveness and readiness checks until
      it succeeds, making sure those probes don&rsquo;t interfere with the application startup.
      This can be used to adopt liveness checks on slow starting containers, avoiding them
      getting killed by the kubelet before they are up and running.
    </p>
    <ul id="markdown-toc">
      <li>
        <a href="#before-you-begin">
          Before you begin
        </a>
      </li>
      <li>
        <a href="#define-a-liveness-command">
          Define a liveness command
        </a>
      </li>
      <li>
        <a href="#define-a-liveness-http-request">
          Define a liveness HTTP request
        </a>
      </li>
      <li>
        <a href="#define-a-tcp-liveness-probe">
          Define a TCP liveness probe
        </a>
      </li>
      <li>
        <a href="#use-a-named-port">
          Use a named port
        </a>
      </li>
      <li>
        <a href="#define-startup-probes">
          Protect slow starting containers with startup probes
        </a>
      </li>
      <li>
        <a href="#define-readiness-probes">
          Define readiness probes
        </a>
      </li>
      <li>
        <a href="#configure-probes">
          Configure Probes
        </a>
      </li>
      <li>
        <a href="#what-s-next">
          What's next
        </a>
      </li>
    </ul>
    <h2 id="before-you-begin">
      Before you begin
    </h2>
    <p>
      You need to have a Kubernetes cluster, and the kubectl command-line tool must
      be configured to communicate with your cluster. If you do not already have a
      cluster, you can create one by using
      <a href="/docs/setup/learning-environment/minikube/">
        Minikube
      </a>
      ,
      or you can use one of these Kubernetes playgrounds:
    </p>
    <ul>
      <li>
        <a href="https://www.katacoda.com/courses/kubernetes/playground">
          Katacoda
        </a>
      </li>
      <li>
        <a href="http://labs.play-with-k8s.com/">
          Play with Kubernetes
        </a>
      </li>
    </ul>
    <p>
      To check the version, enter
      <code>
        kubectl version
      </code>
      .
    </p>
    <h2 id="define-a-liveness-command">
      Define a liveness command
    </h2>
    <p>
      Many applications running for long periods of time eventually transition to
      broken states, and cannot recover except by being restarted. Kubernetes provides
      liveness probes to detect and remedy such situations.
    </p>
    <p>
      In this exercise, you create a Pod that runs a container based on the
      <code>
        k8s.gcr.io/busybox
      </code>
      image. Here is the configuration file for the Pod:
    </p>
    <table class="includecode" id="pods-probe-exec-liveness-yaml">
      <thead>
        <tr>
          <th>
            <a href="https://raw.githubusercontent.com/kubernetes/website/master/content/en/examples/pods/probe/exec-liveness.yaml" download="pods/probe/exec-liveness.yaml">
              <code>
                pods/probe/exec-liveness.yaml
              </code>
            </a>
            <img src="/dir2/images/copycode.svg" style="max-height:24px; cursor: pointer" onclick="copyCode('pods-probe-exec-liveness-yaml')" title="Copy pods/probe/exec-liveness.yaml to clipboard">
          </th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <div class="highlight">
              <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#a2f;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">labels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">test</span>:<span style="color:#bbb"> </span>liveness<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>liveness-exec<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">containers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>liveness<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">image</span>:<span style="color:#bbb"> </span>k8s.gcr.io/busybox<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">args</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- /bin/sh<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- -c<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- touch<span style="color:#bbb"> </span>/tmp/healthy;<span style="color:#bbb"> </span>sleep<span style="color:#bbb"> </span><span style="color:#666">30</span>;<span style="color:#bbb"> </span>rm<span style="color:#bbb"> </span>-rf<span style="color:#bbb"> </span>/tmp/healthy;<span style="color:#bbb"> </span>sleep<span style="color:#bbb"> </span><span style="color:#666">600</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">livenessProbe</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">exec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">command</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>- cat<span style="color:#bbb">
</span><span style="color:#bbb">        </span>- /tmp/healthy<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">initialDelaySeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">periodSeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span></code></pre>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <p>
      In the configuration file, you can see that the Pod has a single
      <code>
        Container
      </code>
      .
      The
      <code>
        periodSeconds
      </code>
      field specifies that the kubelet should perform a liveness
      probe every 5 seconds. The
      <code>
        initialDelaySeconds
      </code>
      field tells the kubelet that it
      should wait 5 seconds before performing the first probe. To perform a probe, the
      kubelet executes the command
      <code>
        cat /tmp/healthy
      </code>
      in the target container. If the
      command succeeds, it returns 0, and the kubelet considers the container to be alive and
      healthy. If the command returns a non-zero value, the kubelet kills the container
      and restarts it.
    </p>
    <p>
      When the container starts, it executes this command:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">/bin/sh -c <span style="color:#b44">&#34;touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600&#34;</span></code></pre>
    </div>
    <p>
      For the first 30 seconds of the container&rsquo;s life, there is a
      <code>
        /tmp/healthy
      </code>
      file.
      So during the first 30 seconds, the command
      <code>
        cat /tmp/healthy
      </code>
      returns a success
      code. After 30 seconds,
      <code>
        cat /tmp/healthy
      </code>
      returns a failure code.
    </p>
    <p>
      Create the Pod:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f https://k8s.io/examples/pods/probe/exec-liveness.yaml</code></pre>
    </div>
    <p>
      Within 30 seconds, view the Pod events:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl describe pod liveness-exec</code></pre>
    </div>
    <p>
      The output indicates that no liveness probes have failed yet:
    </p>
    <pre><code>FirstSeen    LastSeen    Count   From            SubobjectPath           Type        Reason      Message
--------- --------    -----   ----            -------------           --------    ------      -------
24s       24s     1   {default-scheduler }                    Normal      Scheduled   Successfully assigned liveness-exec to worker0
23s       23s     1   {kubelet worker0}   spec.containers{liveness}   Normal      Pulling     pulling image &quot;k8s.gcr.io/busybox&quot;
23s       23s     1   {kubelet worker0}   spec.containers{liveness}   Normal      Pulled      Successfully pulled image &quot;k8s.gcr.io/busybox&quot;
23s       23s     1   {kubelet worker0}   spec.containers{liveness}   Normal      Created     Created container with docker id 86849c15382e; Security:[seccomp=unconfined]
23s       23s     1   {kubelet worker0}   spec.containers{liveness}   Normal      Started     Started container with docker id 86849c15382e</code></pre>
    <p>
      After 35 seconds, view the Pod events again:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl describe pod liveness-exec</code></pre>
    </div>
    <p>
      At the bottom of the output, there are messages indicating that the liveness
      probes have failed, and the containers have been killed and recreated.
    </p>
    <pre><code>FirstSeen LastSeen    Count   From            SubobjectPath           Type        Reason      Message
--------- --------    -----   ----            -------------           --------    ------      -------
37s       37s     1   {default-scheduler }                    Normal      Scheduled   Successfully assigned liveness-exec to worker0
36s       36s     1   {kubelet worker0}   spec.containers{liveness}   Normal      Pulling     pulling image &quot;k8s.gcr.io/busybox&quot;
36s       36s     1   {kubelet worker0}   spec.containers{liveness}   Normal      Pulled      Successfully pulled image &quot;k8s.gcr.io/busybox&quot;
36s       36s     1   {kubelet worker0}   spec.containers{liveness}   Normal      Created     Created container with docker id 86849c15382e; Security:[seccomp=unconfined]
36s       36s     1   {kubelet worker0}   spec.containers{liveness}   Normal      Started     Started container with docker id 86849c15382e
2s        2s      1   {kubelet worker0}   spec.containers{liveness}   Warning     Unhealthy   Liveness probe failed: cat: can't open '/tmp/healthy': No such file or directory</code></pre>
    <p>
      Wait another 30 seconds, and verify that the container has been restarted:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pod liveness-exec</code></pre>
    </div>
    <p>
      The output shows that
      <code>
        RESTARTS
      </code>
      has been incremented:
    </p>
    <pre><code>NAME            READY     STATUS    RESTARTS   AGE
liveness-exec   1/1       Running   1          1m</code></pre>
    <h2 id="define-a-liveness-http-request">
      Define a liveness HTTP request
    </h2>
    <p>
      Another kind of liveness probe uses an HTTP GET request. Here is the configuration
      file for a Pod that runs a container based on the
      <code>
        k8s.gcr.io/liveness
      </code>
      image.
    </p>
    <table class="includecode" id="pods-probe-http-liveness-yaml">
      <thead>
        <tr>
          <th>
            <a href="https://raw.githubusercontent.com/kubernetes/website/master/content/en/examples/pods/probe/http-liveness.yaml" download="pods/probe/http-liveness.yaml">
              <code>
                pods/probe/http-liveness.yaml
              </code>
            </a>
            <img src="/dir2/images/copycode.svg" style="max-height:24px; cursor: pointer" onclick="copyCode('pods-probe-http-liveness-yaml')" title="Copy pods/probe/http-liveness.yaml to clipboard">
          </th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <div class="highlight">
              <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#a2f;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">labels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">test</span>:<span style="color:#bbb"> </span>liveness<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>liveness-http<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">containers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>liveness<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">image</span>:<span style="color:#bbb"> </span>k8s.gcr.io/liveness<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">args</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- /server<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">livenessProbe</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">httpGet</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">path</span>:<span style="color:#bbb"> </span>/healthz<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">port</span>:<span style="color:#bbb"> </span><span style="color:#666">8080</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">httpHeaders</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>Custom-Header<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">value</span>:<span style="color:#bbb"> </span>Awesome<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">initialDelaySeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">periodSeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span></code></pre>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <p>
      In the configuration file, you can see that the Pod has a single container.
      The
      <code>
        periodSeconds
      </code>
      field specifies that the kubelet should perform a liveness
      probe every 3 seconds. The
      <code>
        initialDelaySeconds
      </code>
      field tells the kubelet that it
      should wait 3 seconds before performing the first probe. To perform a probe, the
      kubelet sends an HTTP GET request to the server that is running in the container
      and listening on port 8080. If the handler for the server&rsquo;s
      <code>
        /healthz
      </code>
      path
      returns a success code, the kubelet considers the container to be alive and
      healthy. If the handler returns a failure code, the kubelet kills the container
      and restarts it.
    </p>
    <p>
      Any code greater than or equal to 200 and less than 400 indicates success. Any
      other code indicates failure.
    </p>
    <p>
      You can see the source code for the server in
      <a href="https://github.com/kubernetes/kubernetes/blob/master/test/images/agnhost/liveness/server.go">
        server.go
      </a>
      .
    </p>
    <p>
      For the first 10 seconds that the container is alive, the
      <code>
        /healthz
      </code>
      handler
      returns a status of 200. After that, the handler returns a status of 500.
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">http.<span style="color:#00a000">HandleFunc</span>(<span style="color:#b44">&#34;/healthz&#34;</span>, <span style="color:#a2f;font-weight:bold">func</span>(w http.ResponseWriter, r <span style="color:#666">*</span>http.Request) {
    duration <span style="color:#666">:=</span> time.<span style="color:#00a000">Now</span>().<span style="color:#00a000">Sub</span>(started)
    <span style="color:#a2f;font-weight:bold">if</span> duration.<span style="color:#00a000">Seconds</span>() &gt; <span style="color:#666">10</span> {
        w.<span style="color:#00a000">WriteHeader</span>(<span style="color:#666">500</span>)
        w.<span style="color:#00a000">Write</span>([]<span style="color:#a2f">byte</span>(fmt.<span style="color:#00a000">Sprintf</span>(<span style="color:#b44">&#34;error: %v&#34;</span>, duration.<span style="color:#00a000">Seconds</span>())))
    } <span style="color:#a2f;font-weight:bold">else</span> {
        w.<span style="color:#00a000">WriteHeader</span>(<span style="color:#666">200</span>)
        w.<span style="color:#00a000">Write</span>([]<span style="color:#a2f">byte</span>(<span style="color:#b44">&#34;ok&#34;</span>))
    }
})</code></pre>
    </div>
    <p>
      The kubelet starts performing health checks 3 seconds after the container starts.
      So the first couple of health checks will succeed. But after 10 seconds, the health
      checks will fail, and the kubelet will kill and restart the container.
    </p>
    <p>
      To try the HTTP liveness check, create a Pod:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f https://k8s.io/examples/pods/probe/http-liveness.yaml</code></pre>
    </div>
    <p>
      After 10 seconds, view Pod events to verify that liveness probes have failed and
      the container has been restarted:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl describe pod liveness-http</code></pre>
    </div>
    <p>
      In releases prior to v1.13 (including v1.13), if the environment variable
      <code>
        http_proxy
      </code>
      (or
      <code>
        HTTP_PROXY
      </code>
      ) is set on the node where a Pod is running,
      the HTTP liveness probe uses that proxy.
      In releases after v1.13, local HTTP proxy environment variable settings do not
      affect the HTTP liveness probe.
    </p>
    <h2 id="define-a-tcp-liveness-probe">
      Define a TCP liveness probe
    </h2>
    <p>
      A third type of liveness probe uses a TCP socket. With this configuration, the
      kubelet will attempt to open a socket to your container on the specified port.
      If it can establish a connection, the container is considered healthy, if it
      can’t it is considered a failure.
    </p>
    <table class="includecode" id="pods-probe-tcp-liveness-readiness-yaml">
      <thead>
        <tr>
          <th>
            <a href="https://raw.githubusercontent.com/kubernetes/website/master/content/en/examples/pods/probe/tcp-liveness-readiness.yaml" download="pods/probe/tcp-liveness-readiness.yaml">
              <code>
                pods/probe/tcp-liveness-readiness.yaml
              </code>
            </a>
            <img src="/dir2/images/copycode.svg" style="max-height:24px; cursor: pointer" onclick="copyCode('pods-probe-tcp-liveness-readiness-yaml')" title="Copy pods/probe/tcp-liveness-readiness.yaml to clipboard">
          </th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <div class="highlight">
              <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#a2f;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>goproxy<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">labels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">app</span>:<span style="color:#bbb"> </span>goproxy<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">containers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>goproxy<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">image</span>:<span style="color:#bbb"> </span>k8s.gcr.io/goproxy:<span style="color:#666">0.1</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">ports</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- <span style="color:#a2f;font-weight:bold">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">8080</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">readinessProbe</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">tcpSocket</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">port</span>:<span style="color:#bbb"> </span><span style="color:#666">8080</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">initialDelaySeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">periodSeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">10</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">livenessProbe</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">tcpSocket</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">port</span>:<span style="color:#bbb"> </span><span style="color:#666">8080</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">initialDelaySeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">15</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">periodSeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">20</span><span style="color:#bbb">
</span></code></pre>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <p>
      As you can see, configuration for a TCP check is quite similar to an HTTP check.
      This example uses both readiness and liveness probes. The kubelet will send the
      first readiness probe 5 seconds after the container starts. This will attempt to
      connect to the
      <code>
        goproxy
      </code>
      container on port 8080. If the probe succeeds, the Pod
      will be marked as ready. The kubelet will continue to run this check every 10
      seconds.
    </p>
    <p>
      In addition to the readiness probe, this configuration includes a liveness probe.
      The kubelet will run the first liveness probe 15 seconds after the container
      starts. Just like the readiness probe, this will attempt to connect to the
      <code>
        goproxy
      </code>
      container on port 8080. If the liveness probe fails, the container
      will be restarted.
    </p>
    <p>
      To try the TCP liveness check, create a Pod:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f https://k8s.io/examples/pods/probe/tcp-liveness-readiness.yaml</code></pre>
    </div>
    <p>
      After 15 seconds, view Pod events to verify that liveness probes:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl describe pod goproxy</code></pre>
    </div>
    <h2 id="use-a-named-port">
      Use a named port
    </h2>
    <p>
      You can use a named
      <a href="/docs/reference/generated/kubernetes-api/v1.18/#containerport-v1-core">
        ContainerPort
      </a>
      for HTTP or TCP liveness checks:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#a2f;font-weight:bold">ports</span>:<span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>liveness-port<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">8080</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">hostPort</span>:<span style="color:#bbb"> </span><span style="color:#666">8080</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">livenessProbe</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">httpGet</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">path</span>:<span style="color:#bbb"> </span>/healthz<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">port</span>:<span style="color:#bbb"> </span>liveness-port<span style="color:#bbb">
</span></code></pre>
    </div>
    <h2 id="define-startup-probes">
      Protect slow starting containers with startup probes
    </h2>
    <p>
      Sometimes, you have to deal with legacy applications that might require
      an additional startup time on their first initialization.
      In such cases, it can be tricky to set up liveness probe parameters without
      compromising the fast response to deadlocks that motivated such a probe.
      The trick is to set up a startup probe with the same command, HTTP or TCP
      check, with a
      <code>
        failureThreshold * periodSeconds
      </code>
      long enough to cover the
      worse case startup time.
    </p>
    <p>
      So, the previous example would become:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#a2f;font-weight:bold">ports</span>:<span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>liveness-port<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">8080</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">hostPort</span>:<span style="color:#bbb"> </span><span style="color:#666">8080</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">livenessProbe</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">httpGet</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">path</span>:<span style="color:#bbb"> </span>/healthz<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">port</span>:<span style="color:#bbb"> </span>liveness-port<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">failureThreshold</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">periodSeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">10</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">startupProbe</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">httpGet</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">path</span>:<span style="color:#bbb"> </span>/healthz<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">port</span>:<span style="color:#bbb"> </span>liveness-port<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">failureThreshold</span>:<span style="color:#bbb"> </span><span style="color:#666">30</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">periodSeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">10</span><span style="color:#bbb">
</span></code></pre>
    </div>
    <p>
      Thanks to the startup probe, the application will have a maximum of 5 minutes
      (30 * 10 = 300s) to finish its startup.
      Once the startup probe has succeeded once, the liveness probe takes over to
      provide a fast response to container deadlocks.
      If the startup probe never succeeds, the container is killed after 300s and
      subject to the pod&rsquo;s
      <code>
        restartPolicy
      </code>
      .
    </p>
    <h2 id="define-readiness-probes">
      Define readiness probes
    </h2>
    <p>
      Sometimes, applications are temporarily unable to serve traffic.
      For example, an application might need to load large data or configuration
      files during startup, or depend on external services after startup.
      In such cases, you don&rsquo;t want to kill the application,
      but you don’t want to send it requests either. Kubernetes provides
      readiness probes to detect and mitigate these situations. A pod with containers
      reporting that they are not ready does not receive traffic through Kubernetes
      Services.
    </p>
    <blockquote class="note">
      <div>
        <strong>
          Note:
        </strong>
        Readiness probes runs on the container during its whole lifecycle.
      </div>
    </blockquote>
    <p>
      Readiness probes are configured similarly to liveness probes. The only difference
      is that you use the
      <code>
        readinessProbe
      </code>
      field instead of the
      <code>
        livenessProbe
      </code>
      field.
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#a2f;font-weight:bold">readinessProbe</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">exec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">command</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- cat<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- /tmp/healthy<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">initialDelaySeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">periodSeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span></code></pre>
    </div>
    <p>
      Configuration for HTTP and TCP readiness probes also remains identical to
      liveness probes.
    </p>
    <p>
      Readiness and liveness probes can be used in parallel for the same container.
      Using both can ensure that traffic does not reach a container that is not ready
      for it, and that containers are restarted when they fail.
    </p>
    <h2 id="configure-probes">
      Configure Probes
    </h2>
    <p>
      <a href="/docs/reference/generated/kubernetes-api/v1.18/#probe-v1-core">
        Probes
      </a>
      have a number of fields that
      you can use to more precisely control the behavior of liveness and readiness
      checks:
    </p>
    <ul>
      <li>
        <code>
          initialDelaySeconds
        </code>
        : Number of seconds after the container has started
        before liveness or readiness probes are initiated. Defaults to 0 seconds. Minimum value is 0.
      </li>
      <li>
        <code>
          periodSeconds
        </code>
        : How often (in seconds) to perform the probe. Default to 10
        seconds. Minimum value is 1.
      </li>
      <li>
        <code>
          timeoutSeconds
        </code>
        : Number of seconds after which the probe times out. Defaults
        to 1 second. Minimum value is 1.
      </li>
      <li>
        <code>
          successThreshold
        </code>
        : Minimum consecutive successes for the probe to be
        considered successful after having failed. Defaults to 1. Must be 1 for
        liveness. Minimum value is 1.
      </li>
      <li>
        <code>
          failureThreshold
        </code>
        : When a Pod starts and the probe fails, Kubernetes will
        try
        <code>
          failureThreshold
        </code>
        times before giving up. Giving up in case of liveness probe means restarting the container. In case of readiness probe the Pod will be marked Unready.
        Defaults to 3. Minimum value is 1.
      </li>
    </ul>
    <p>
      <a href="/docs/reference/generated/kubernetes-api/v1.18/#httpgetaction-v1-core">
        HTTP probes
      </a>
      have additional fields that can be set on
      <code>
        httpGet
      </code>
      :
    </p>
    <ul>
      <li>
        <code>
          host
        </code>
        : Host name to connect to, defaults to the pod IP. You probably want to
        set &ldquo;Host&rdquo; in httpHeaders instead.
      </li>
      <li>
        <code>
          scheme
        </code>
        : Scheme to use for connecting to the host (HTTP or HTTPS). Defaults to HTTP.
      </li>
      <li>
        <code>
          path
        </code>
        : Path to access on the HTTP server.
      </li>
      <li>
        <code>
          httpHeaders
        </code>
        : Custom headers to set in the request. HTTP allows repeated headers.
      </li>
      <li>
        <code>
          port
        </code>
        : Name or number of the port to access on the container. Number must be
        in the range 1 to 65535.
      </li>
    </ul>
    <p>
      For an HTTP probe, the kubelet sends an HTTP request to the specified path and
      port to perform the check. The kubelet sends the probe to the pod’s IP address,
      unless the address is overridden by the optional
      <code>
        host
      </code>
      field in
      <code>
        httpGet
      </code>
      . If
      <code>
        scheme
      </code>
      field is set to
      <code>
        HTTPS
      </code>
      , the kubelet sends an HTTPS request skipping the
      certificate verification. In most scenarios, you do not want to set the
      <code>
        host
      </code>
      field.
      Here&rsquo;s one scenario where you would set it. Suppose the container listens on 127.0.0.1
      and the Pod&rsquo;s
      <code>
        hostNetwork
      </code>
      field is true. Then
      <code>
        host
      </code>
      , under
      <code>
        httpGet
      </code>
      , should be set
      to 127.0.0.1. If your pod relies on virtual hosts, which is probably the more common
      case, you should not use
      <code>
        host
      </code>
      , but rather set the
      <code>
        Host
      </code>
      header in
      <code>
        httpHeaders
      </code>
      .
    </p>
    <p>
      For a TCP probe, the kubelet makes the probe connection at the node, not in the pod, which
      means that you can not use a service name in the
      <code>
        host
      </code>
      parameter since the kubelet is unable
      to resolve it.
    </p>
    <h2 id="what-s-next">
      What&#39;s next
    </h2>
    <ul>
      <li>
        Learn more about
        <a href="/docs/concepts/workloads/pods/pod-lifecycle/#container-probes">
          Container Probes
        </a>
        .
      </li>
    </ul>
    <p>
      You can also read the API references for:
    </p>
    <ul>
      <li>
        <a href="/docs/reference/generated/kubernetes-api/v1.18/#pod-v1-core">
          Pod
        </a>
      </li>
      <li>
        <a href="/docs/reference/generated/kubernetes-api/v1.18/#container-v1-core">
          Container
        </a>
      </li>
      <li>
        <a href="/docs/reference/generated/kubernetes-api/v1.18/#probe-v1-core">
          Probe
        </a>
      </li>
    </ul>
  </body>
</html>