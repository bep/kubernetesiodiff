<html><head></head><body>
    <h1>
      Example: Deploying Cassandra with a StatefulSet
    </h1>
    <p>
      <a href="https://github.com/kubernetes/website/edit/master/content/en/docs/tutorials/stateful-application/cassandra.md" id="editPageButton" target="_blank">
        Edit This Page
      </a>
    </p>
    <h1>
      Example: Deploying Cassandra with a StatefulSet
    </h1>
    <p>
      This tutorial shows you how to run
      <a href="http://cassandra.apache.org/">
        Apache Cassandra
      </a>
      on Kubernetes. Cassandra, a database, needs persistent storage to provide data durability (application
      <em>
        state
      </em>
      ). In this example, a custom Cassandra seed provider lets the database discover new Cassandra instances as they join the Cassandra cluster.
    </p>
    <p>
      <em>
        StatefulSets
      </em>
      make it easier to deploy stateful applications into your Kubernetes cluster. For more information on the features used in this tutorial, see
      <a href="/docs/concepts/workloads/controllers/statefulset/">
        StatefulSet
      </a>
      .
    </p>
    <blockquote class="note">
      <div>
        <strong>
          Note:
        </strong>
        <p>
          Cassandra and Kubernetes both use the term
          <em>
            node
          </em>
          to mean a member of a cluster. In this
          tutorial, the Pods that belong to the StatefulSet are Cassandra nodes and are members
          of the Cassandra cluster (called a
          <em>
            ring
          </em>
          ). When those Pods run in your Kubernetes cluster,
          the Kubernetes control plane schedules those Pods onto Kubernetes
          <a class="glossary-tooltip" href="/docs/concepts/architecture/nodes/" target="_blank">
            Nodes
            <span class="tooltip-text">
              A node is a worker machine in Kubernetes.
            </span>
          </a>
          .
        </p>
        <p>
          When a Cassandra node starts, it uses a
          <em>
            seed list
          </em>
          to bootstrap discovery of other
          nodes in the ring.
          This tutorial deploys a custom Cassandra seed provider that lets the database discover
          new Cassandra Pods as they appear inside your Kubernetes cluster.
        </p>
      </div>
    </blockquote>
    <ul id="markdown-toc">
      <li>
        <a href="#objectives">
          Objectives
        </a>
      </li>
      <li>
        <a href="#before-you-begin">
          Before you begin
        </a>
      </li>
      <li>
        <a href="#creating-a-cassandra-headless-service">
          Creating a headless Service for Cassandra
        </a>
      </li>
      <li>
        <a href="#using-a-statefulset-to-create-a-cassandra-ring">
          Using a StatefulSet to create a Cassandra ring
        </a>
      </li>
      <li>
        <a href="#validating-the-cassandra-statefulset">
          Validating the Cassandra StatefulSet
        </a>
      </li>
      <li>
        <a href="#modifying-the-cassandra-statefulset">
          Modifying the Cassandra StatefulSet
        </a>
      </li>
      <li>
        <a href="#cleaning-up">
          Cleaning up
        </a>
      </li>
      <li>
        <a href="#cassandra-container-environment-variables">
          Cassandra container environment variables
        </a>
      </li>
      <li>
        <a href="#what-s-next">
          What&#39;s next
        </a>
      </li>
    </ul>
    <h2 id="objectives">
      Objectives
    </h2>
    <ul>
      <li>
        Create and validate a Cassandra headless
        <a class="glossary-tooltip" href="/docs/concepts/services-networking/service/" target="_blank">
          Service
          <span class="tooltip-text">
            A way to expose an application running on a set of Pods as a network service.
          </span>
        </a>
        .
      </li>
      <li>
        Use a
        <a class="glossary-tooltip" href="/docs/concepts/workloads/controllers/statefulset/" target="_blank">
          StatefulSet
          <span class="tooltip-text">
            Manages the deployment and scaling of a set of Pods, and provides guarantees about the ordering and uniqueness of these Pods.
          </span>
        </a>
        to create a Cassandra ring.
      </li>
      <li>
        Validate the StatefulSet.
      </li>
      <li>
        Modify the StatefulSet.
      </li>
      <li>
        Delete the StatefulSet and its
        <a class="glossary-tooltip" href="/docs/concepts/workloads/pods/pod-overview/" target="_blank">
          Pods
          <span class="tooltip-text">
            The smallest and simplest Kubernetes object. A Pod represents a set of running containers on your cluster.
          </span>
        </a>
        .
      </li>
    </ul>
    <h2 id="before-you-begin">
      Before you begin
    </h2>
    <p>
      You need to have a Kubernetes cluster, and the kubectl command-line tool must
      be configured to communicate with your cluster. If you do not already have a
      cluster, you can create one by using
      <a href="/docs/setup/learning-environment/minikube/">
        Minikube
      </a>
      ,
      or you can use one of these Kubernetes playgrounds:
    </p>
    <ul>
      <li>
        <a href="https://www.katacoda.com/courses/kubernetes/playground">
          Katacoda
        </a>
      </li>
      <li>
        <a href="http://labs.play-with-k8s.com/">
          Play with Kubernetes
        </a>
      </li>
    </ul>
    <p>
      To complete this tutorial, you should already have a basic familiarity with
      <a class="glossary-tooltip" href="/docs/concepts/workloads/pods/pod-overview/" target="_blank">
        Pods
        <span class="tooltip-text">
          The smallest and simplest Kubernetes object. A Pod represents a set of running containers on your cluster.
        </span>
      </a>
      ,
      <a class="glossary-tooltip" href="/docs/concepts/services-networking/service/" target="_blank">
        Services
        <span class="tooltip-text">
          A way to expose an application running on a set of Pods as a network service.
        </span>
      </a>
      , and
      <a class="glossary-tooltip" href="/docs/concepts/workloads/controllers/statefulset/" target="_blank">
        StatefulSets
        <span class="tooltip-text">
          Manages the deployment and scaling of a set of Pods, and provides guarantees about the ordering and uniqueness of these Pods.
        </span>
      </a>
      .
    </p>
    <h3 id="additional-minikube-setup-instructions">
      Additional Minikube setup instructions
    </h3>
    <blockquote class="caution">
      <div>
        <strong>
          Caution:
        </strong>
        <p>
          <a href="/docs/getting-started-guides/minikube/">
            Minikube
          </a>
          defaults to 1024MiB of memory and 1 CPU. Running Minikube with the default resource configuration results in insufficient resource errors during this tutorial. To avoid these errors, start Minikube with the following settings:
        </p>
        <div class="highlight">
          <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">minikube start --memory <span style="color:#666">5120</span> --cpus<span style="color:#666">=</span><span style="color:#666">4</span></code></pre>
        </div>
      </div>
    </blockquote>
    <h2 id="creating-a-cassandra-headless-service">
      Creating a headless Service for Cassandra
    </h2>
    <p>
      In Kubernetes, a
      <a class="glossary-tooltip" href="/docs/concepts/services-networking/service/" target="_blank">
        Service
        <span class="tooltip-text">
          A way to expose an application running on a set of Pods as a network service.
        </span>
      </a>
      describes a set of
      <a class="glossary-tooltip" href="/docs/concepts/workloads/pods/pod-overview/" target="_blank">
        Pods
        <span class="tooltip-text">
          The smallest and simplest Kubernetes object. A Pod represents a set of running containers on your cluster.
        </span>
      </a>
      that perform the same task.
    </p>
    <p>
      The following Service is used for DNS lookups between Cassandra Pods and clients within your cluster:
    </p>
    <table class="includecode" id="application-cassandra-cassandra-service-yaml">
      <thead>
        <tr>
          <th>
            <a href="https://raw.githubusercontent.com/kubernetes/website/master/content/en/examples/application/cassandra/cassandra-service.yaml" download="application/cassandra/cassandra-service.yaml">
              <code>
                application/cassandra/cassandra-service.yaml
              </code>
            </a>
            <img src="/dir1/images/copycode.svg" style="max-height:24px; cursor: pointer" onclick="copyCode(&#39;application-cassandra-cassandra-service-yaml&#39;)" title="Copy application/cassandra/cassandra-service.yaml to clipboard"/>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <div class="highlight">
              <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#a2f;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Service<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">labels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">app</span>:<span style="color:#bbb"> </span>cassandra<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>cassandra<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">clusterIP</span>:<span style="color:#bbb"> </span>None<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">ports</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#a2f;font-weight:bold">port</span>:<span style="color:#bbb"> </span><span style="color:#666">9042</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">selector</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">app</span>:<span style="color:#bbb"> </span>cassandra<span style="color:#bbb">
</span></code></pre>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <p>
      Create a Service to track all Cassandra StatefulSet members from the
      <code>
        cassandra-service.yaml
      </code>
      file:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f https://k8s.io/examples/application/cassandra/cassandra-service.yaml</code></pre>
    </div>
    <h3 id="validating">
      Validating (optional)
    </h3>
    <p>
      Get the Cassandra Service.
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get svc cassandra</code></pre>
    </div>
    <p>
      The response is
    </p>
    <pre><code>NAME        TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE
cassandra   ClusterIP   None         &lt;none&gt;        9042/TCP   45s</code></pre>
    <p>
      If you don’t see a Service named
      <code>
        cassandra
      </code>
      , that means creation failed. Read
      <a href="/docs/tasks/debug-application-cluster/debug-service/">
        Debug Services
      </a>
      for help troubleshooting common issues.
    </p>
    <h2 id="using-a-statefulset-to-create-a-cassandra-ring">
      Using a StatefulSet to create a Cassandra ring
    </h2>
    <p>
      The StatefulSet manifest, included below, creates a Cassandra ring that consists of three Pods.
    </p>
    <blockquote class="note">
      <div>
        <strong>
          Note:
        </strong>
        This example uses the default provisioner for Minikube. Please update the following StatefulSet for the cloud you are working with.
      </div>
    </blockquote>
    <table class="includecode" id="application-cassandra-cassandra-statefulset-yaml">
      <thead>
        <tr>
          <th>
            <a href="https://raw.githubusercontent.com/kubernetes/website/master/content/en/examples/application/cassandra/cassandra-statefulset.yaml" download="application/cassandra/cassandra-statefulset.yaml">
              <code>
                application/cassandra/cassandra-statefulset.yaml
              </code>
            </a>
            <img src="/dir1/images/copycode.svg" style="max-height:24px; cursor: pointer" onclick="copyCode(&#39;application-cassandra-cassandra-statefulset-yaml&#39;)" title="Copy application/cassandra/cassandra-statefulset.yaml to clipboard"/>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <div class="highlight">
              <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#a2f;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>StatefulSet<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>cassandra<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">labels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">app</span>:<span style="color:#bbb"> </span>cassandra<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">serviceName</span>:<span style="color:#bbb"> </span>cassandra<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">selector</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">matchLabels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">app</span>:<span style="color:#bbb"> </span>cassandra<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">template</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">labels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">app</span>:<span style="color:#bbb"> </span>cassandra<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">terminationGracePeriodSeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">1800</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">containers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>cassandra<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">image</span>:<span style="color:#bbb"> </span>gcr.io/google-samples/cassandra:v13<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">imagePullPolicy</span>:<span style="color:#bbb"> </span>Always<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">ports</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>- <span style="color:#a2f;font-weight:bold">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">7000</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>intra-node<span style="color:#bbb">
</span><span style="color:#bbb">        </span>- <span style="color:#a2f;font-weight:bold">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">7001</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>tls-intra-node<span style="color:#bbb">
</span><span style="color:#bbb">        </span>- <span style="color:#a2f;font-weight:bold">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">7199</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>jmx<span style="color:#bbb">
</span><span style="color:#bbb">        </span>- <span style="color:#a2f;font-weight:bold">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">9042</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>cql<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">resources</span>:<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">limits</span>:<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#a2f;font-weight:bold">cpu</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;500m&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#a2f;font-weight:bold">memory</span>:<span style="color:#bbb"> </span>1Gi<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">requests</span>:<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#a2f;font-weight:bold">cpu</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;500m&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#a2f;font-weight:bold">memory</span>:<span style="color:#bbb"> </span>1Gi<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">securityContext</span>:<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">capabilities</span>:<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#a2f;font-weight:bold">add</span>:<span style="color:#bbb">
</span><span style="color:#bbb">              </span>- IPC_LOCK<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">lifecycle</span>:<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">preStop</span>:<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#a2f;font-weight:bold">exec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">              </span><span style="color:#a2f;font-weight:bold">command</span>:<span style="color:#bbb"> 
</span><span style="color:#bbb">              </span>- /bin/sh<span style="color:#bbb">
</span><span style="color:#bbb">              </span>- -c<span style="color:#bbb">
</span><span style="color:#bbb">              </span>- nodetool<span style="color:#bbb"> </span>drain<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">env</span>:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>MAX_HEAP_SIZE<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#a2f;font-weight:bold">value</span>:<span style="color:#bbb"> </span>512M<span style="color:#bbb">
</span><span style="color:#bbb">          </span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>HEAP_NEWSIZE<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#a2f;font-weight:bold">value</span>:<span style="color:#bbb"> </span>100M<span style="color:#bbb">
</span><span style="color:#bbb">          </span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>CASSANDRA_SEEDS<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#a2f;font-weight:bold">value</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;cassandra-0.cassandra.default.svc.cluster.local&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>CASSANDRA_CLUSTER_NAME<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#a2f;font-weight:bold">value</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;K8Demo&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>CASSANDRA_DC<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#a2f;font-weight:bold">value</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;DC1-K8Demo&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>CASSANDRA_RACK<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#a2f;font-weight:bold">value</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;Rack1-K8Demo&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>POD_IP<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#a2f;font-weight:bold">valueFrom</span>:<span style="color:#bbb">
</span><span style="color:#bbb">              </span><span style="color:#a2f;font-weight:bold">fieldRef</span>:<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#a2f;font-weight:bold">fieldPath</span>:<span style="color:#bbb"> </span>status.podIP<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">readinessProbe</span>:<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">exec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#a2f;font-weight:bold">command</span>:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>- /bin/bash<span style="color:#bbb">
</span><span style="color:#bbb">            </span>- -c<span style="color:#bbb">
</span><span style="color:#bbb">            </span>- /ready-probe.sh<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">initialDelaySeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">15</span><span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">timeoutSeconds</span>:<span style="color:#bbb"> </span><span style="color:#666">5</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># These volume mounts are persistent. They are like inline claims,</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># but not exactly because the names need to match exactly one of</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># the stateful pod volumes.</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">volumeMounts</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>cassandra-data<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">mountPath</span>:<span style="color:#bbb"> </span>/cassandra_data<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># These are converted to volume claims by the controller</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># and mounted at the paths mentioned above.</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># do not use these in production until ssd GCEPersistentDisk or other ssd pd</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">volumeClaimTemplates</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#a2f;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>cassandra-data<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">accessModes</span>:<span style="color:#bbb"> </span>[<span style="color:#bbb"> </span><span style="color:#b44">&#34;ReadWriteOnce&#34;</span><span style="color:#bbb"> </span>]<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">storageClassName</span>:<span style="color:#bbb"> </span>fast<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">resources</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">requests</span>:<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">storage</span>:<span style="color:#bbb"> </span>1Gi<span style="color:#bbb">
</span><span style="color:#bbb"></span>---<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>StorageClass<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>storage.k8s.io/v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>fast<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">provisioner</span>:<span style="color:#bbb"> </span>k8s.io/minikube-hostpath<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">parameters</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">type</span>:<span style="color:#bbb"> </span>pd-ssd<span style="color:#bbb">
</span></code></pre>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <p>
      Create the Cassandra StatefulSet from the
      <code>
        cassandra-statefulset.yaml
      </code>
      file:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#080;font-style:italic"># Use this if you are able to apply cassandra-statefulset.yaml unmodified</span>
kubectl apply -f https://k8s.io/examples/application/cassandra/cassandra-statefulset.yaml</code></pre>
    </div>
    <p>
      If you need to modify
      <code>
        cassandra-statefulset.yaml
      </code>
      to suit your cluster, download
      <a href="https://k8s.io/examples/application/cassandra/cassandra-statefulset.yaml">
        https://k8s.io/examples/application/cassandra/cassandra-statefulset.yaml
      </a>
      and then apply
      that manifest, from the folder you saved the modified version into:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#080;font-style:italic"># Use this if you needed to modify cassandra-statefulset.yaml locally</span>
kubectl apply -f cassandra-statefulset.yaml</code></pre>
    </div>
    <h2 id="validating-the-cassandra-statefulset">
      Validating the Cassandra StatefulSet
    </h2>
    <ol>
      <li>
        <p>
          Get the Cassandra StatefulSet:
        </p>
        <div class="highlight">
          <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get statefulset cassandra</code></pre>
        </div>
        <p>
          The response should be similar to:
        </p>
        <pre><code>NAME        DESIRED   CURRENT   AGE
cassandra   3         0         13s</code></pre>
        <p>
          The
          <code>
            StatefulSet
          </code>
          resource deploys Pods sequentially.
        </p>
      </li>
      <li>
        <p>
          Get the Pods to see the ordered creation status:
        </p>
        <div class="highlight">
          <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -l<span style="color:#666">=</span><span style="color:#b44">&#34;app=cassandra&#34;</span></code></pre>
        </div>
        <p>
          The response should be similar to:
        </p>
        <div class="highlight">
          <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">NAME          READY     STATUS              RESTARTS   AGE
cassandra-0   1/1       Running             <span style="color:#666">0</span>          1m
cassandra-1   0/1       ContainerCreating   <span style="color:#666">0</span>          8s</code></pre>
        </div>
        <p>
          It can take several minutes for all three Pods to deploy. Once they are deployed, the same command
          returns output similar to:
        </p>
        <pre><code>NAME          READY     STATUS    RESTARTS   AGE
cassandra-0   1/1       Running   0          10m
cassandra-1   1/1       Running   0          9m
cassandra-2   1/1       Running   0          8m</code></pre>
      </li>
      <li>
        <p>
          Run the Cassandra
          <a href="https://cwiki.apache.org/confluence/display/CASSANDRA2/NodeTool">
            nodetool
          </a>
          inside the first Pod, to
          display the status of the ring.
        </p>
        <div class="highlight">
          <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> -it cassandra-0 -- nodetool status</code></pre>
        </div>
        <p>
          The response should look something like:
        </p>
        <pre><code>Datacenter: DC1-K8Demo
======================
Status=Up/Down
|/ State=Normal/Leaving/Joining/Moving
--  Address     Load       Tokens       Owns (effective)  Host ID                               Rack
UN  172.17.0.5  83.57 KiB  32           74.0%             e2dd09e6-d9d3-477e-96c5-45094c08db0f  Rack1-K8Demo
UN  172.17.0.4  101.04 KiB  32           58.8%             f89d6835-3a42-4419-92b3-0e62cae1479c  Rack1-K8Demo
UN  172.17.0.6  84.74 KiB  32           67.1%             a6a1e8c2-3dc5-4417-b1a0-26507af2aaad  Rack1-K8Demo</code></pre>
      </li>
    </ol>
    <h2 id="modifying-the-cassandra-statefulset">
      Modifying the Cassandra StatefulSet
    </h2>
    <p>
      Use
      <code>
        kubectl edit
      </code>
      to modify the size of a Cassandra StatefulSet.
    </p>
    <ol>
      <li>
        <p>
          Run the following command:
        </p>
        <div class="highlight">
          <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl edit statefulset cassandra</code></pre>
        </div>
        <p>
          This command opens an editor in your terminal. The line you need to change is the
          <code>
            replicas
          </code>
          field. The following sample is an excerpt of the StatefulSet file:
        </p>
        <div class="highlight">
          <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#080;font-style:italic"># Please edit the object below. Lines beginning with a &#39;#&#39; will be ignored,</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#080;font-style:italic"># and an empty file will abort the edit. If an error occurs while saving this file will be</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#080;font-style:italic"># reopened with the relevant failures.</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#080;font-style:italic">#</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>StatefulSet<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">creationTimestamp</span>:<span style="color:#bbb"> </span>2016-08-13T18:40:58Z<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">generation</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">labels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">app</span>:<span style="color:#bbb"> </span>cassandra<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>cassandra<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">resourceVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;323&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">uid</span>:<span style="color:#bbb"> </span>7a219483<span style="color:#666">-6185-11e6</span>-a910-42010a8a0fc0<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span></code></pre>
        </div>
      </li>
      <li>
        <p>
          Change the number of replicas to 4, and then save the manifest.
        </p>
        <p>
          The StatefulSet now scales to run with 4 Pods.
        </p>
      </li>
      <li>
        <p>
          Get the Cassandra StatefulSet to verify your change:
        </p>
        <div class="highlight">
          <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get statefulset cassandra</code></pre>
        </div>
        <p>
          The response should be similar to:
        </p>
        <pre><code>NAME        DESIRED   CURRENT   AGE
cassandra   4         4         36m</code></pre>
      </li>
    </ol>
    <p></p>
    <h2 id="cleaning-up">
      Cleaning up
    </h2>
    <p>
      Deleting or scaling a StatefulSet down does not delete the volumes associated with the StatefulSet. This setting is for your safety because your data is more valuable than automatically purging all related StatefulSet resources.
    </p>
    <blockquote class="warning">
      <div>
        <strong>
          Warning:
        </strong>
        Depending on the storage class and reclaim policy, deleting the
        <em>
          PersistentVolumeClaims
        </em>
        may cause the associated volumes to also be deleted. Never assume you’ll be able to access data if its volume claims are deleted.
      </div>
    </blockquote>
    <ol>
      <li>
        <p>
          Run the following commands (chained together into a single command) to delete everything in the Cassandra StatefulSet:
        </p>
        <div class="highlight">
          <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#b8860b">grace</span><span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">$(</span>kubectl get pod cassandra-0 -o<span style="color:#666">=</span><span style="color:#b8860b">jsonpath</span><span style="color:#666">=</span><span style="color:#b44">&#39;{.spec.terminationGracePeriodSeconds}&#39;</span><span style="color:#a2f;font-weight:bold">)</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>  <span style="color:#666">&amp;&amp;</span> kubectl delete statefulset -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>cassandra <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>  <span style="color:#666">&amp;&amp;</span> <span style="color:#a2f">echo</span> <span style="color:#b44">&#34;Sleeping </span><span style="color:#b68;font-weight:bold">${</span><span style="color:#b8860b">grace</span><span style="color:#b68;font-weight:bold">}</span><span style="color:#b44"> seconds&#34;</span> 1&gt;&amp;<span style="color:#666">2</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>  <span style="color:#666">&amp;&amp;</span> sleep <span style="color:#b8860b">$grace</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>  <span style="color:#666">&amp;&amp;</span> kubectl delete persistentvolumeclaim -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>cassandra</code></pre>
        </div>
      </li>
      <li>
        <p>
          Run the following command to delete the Service you set up for Cassandra:
        </p>
        <div class="highlight">
          <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl delete service -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>cassandra</code></pre>
        </div>
      </li>
    </ol>
    <h2 id="cassandra-container-environment-variables">
      Cassandra container environment variables
    </h2>
    <p>
      The Pods in this tutorial use the
      <a href="https://github.com/kubernetes/examples/blob/master/cassandra/image/Dockerfile">
        <code>
          gcr.io/google-samples/cassandra:v13
        </code>
      </a>
      image from Google’s
      <a href="https://cloud.google.com/container-registry/docs/">
        container registry
      </a>
      .
      The Docker image above is based on
      <a href="https://github.com/kubernetes/kubernetes/tree/master/build/debian-base">
        debian-base
      </a>
      and includes OpenJDK 8.
    </p>
    <p>
      This image includes a standard Cassandra installation from the Apache Debian repo.
      By using environment variables you can change values that are inserted into
      <code>
        cassandra.yaml
      </code>
      .
    </p>
    <table>
      <thead>
        <tr>
          <th>
            Environment variable
          </th>
          <th align="center">
            Default value
          </th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <code>
              CASSANDRA_CLUSTER_NAME
            </code>
          </td>
          <td align="center">
            <code>
              &#39;Test Cluster&#39;
            </code>
          </td>
        </tr>
        <tr>
          <td>
            <code>
              CASSANDRA_NUM_TOKENS
            </code>
          </td>
          <td align="center">
            <code>
              32
            </code>
          </td>
        </tr>
        <tr>
          <td>
            <code>
              CASSANDRA_RPC_ADDRESS
            </code>
          </td>
          <td align="center">
            <code>
              0.0.0.0
            </code>
          </td>
        </tr>
      </tbody>
    </table>
    <h2 id="what-s-next">
      What&#39;s next
    </h2>
    <ul>
      <li>
        Learn how to
        <a href="/docs/tasks/run-application/scale-stateful-set/">
          Scale a StatefulSet
        </a>
        .
      </li>
      <li>
        Learn more about the
        <a href="https://github.com/kubernetes/examples/blob/master/cassandra/java/src/main/java/io/k8s/cassandra/KubernetesSeedProvider.java">
          <em>
            KubernetesSeedProvider
          </em>
        </a>
      </li>
      <li>
        See more custom
        <a href="https://git.k8s.io/examples/cassandra/java/README.md">
          Seed Provider Configurations
        </a>
      </li>
    </ul>
  
</body></html>