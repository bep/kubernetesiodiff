<html><head></head><body>
    <h1>
      Connecting Applications with Services
    </h1>
    <p>
      <a href="https://github.com/kubernetes/website/edit/master/content/en/docs/concepts/services-networking/connect-applications-service.md" id="editPageButton" target="_blank">
        Edit This Page
      </a>
    </p>
    <h1>
      Connecting Applications with Services
    </h1>
    <h2 id="the-kubernetes-model-for-connecting-containers">
      The Kubernetes model for connecting containers
    </h2>
    <p>
      Now that you have a continuously running, replicated application you can expose it on a network. Before discussing the Kubernetes approach to networking, it is worthwhile to contrast it with the “normal” way networking works with Docker.
    </p>
    <p>
      By default, Docker uses host-private networking, so containers can talk to other containers only if they are on the same machine. In order for Docker containers to communicate across nodes, there must be allocated ports on the machine’s own IP address, which are then forwarded or proxied to the containers. This obviously means that containers must either coordinate which ports they use very carefully or ports must be allocated dynamically.
    </p>
    <p>
      Coordinating port allocations across multiple developers or teams that provide containers is very difficult to do at scale, and exposes users to cluster-level issues outside of their control. Kubernetes assumes that pods can communicate with other pods, regardless of which host they land on. Kubernetes gives every pod its own cluster-private IP address, so you do not need to explicitly create links between pods or map container ports to host ports. This means that containers within a Pod can all reach each other’s ports on localhost, and all pods in a cluster can see each other without NAT. The rest of this document elaborates on how you can run reliable services on such a networking model.
    </p>
    <p>
      This guide uses a simple nginx server to demonstrate proof of concept. The same principles are embodied in a more complete
      <a href="https://kubernetes.io/blog/2015/07/strong-simple-ssl-for-kubernetes">
        Jenkins CI application
      </a>
      .
    </p>
    <ul id="markdown-toc">
      <li>
        <a href="#exposing-pods-to-the-cluster">
          Exposing pods to the cluster
        </a>
      </li>
      <li>
        <a href="#creating-a-service">
          Creating a Service
        </a>
      </li>
      <li>
        <a href="#accessing-the-service">
          Accessing the Service
        </a>
      </li>
      <li>
        <a href="#securing-the-service">
          Securing the Service
        </a>
      </li>
      <li>
        <a href="#exposing-the-service">
          Exposing the Service
        </a>
      </li>
      <li>
        <a href="#what-s-next">
          What&#39;s next
        </a>
      </li>
    </ul>
    <h2 id="exposing-pods-to-the-cluster">
      Exposing pods to the cluster
    </h2>
    <p>
      We did this in a previous example, but let’s do it once again and focus on the networking perspective.
      Create an nginx Pod, and note that it has a container port specification:
    </p>
    <table class="includecode" id="service-networking-run-my-nginx-yaml">
      <thead>
        <tr>
          <th>
            <a href="https://raw.githubusercontent.com/kubernetes/website/master/content/en/examples/service/networking/run-my-nginx.yaml" download="service/networking/run-my-nginx.yaml">
              <code>
                service/networking/run-my-nginx.yaml
              </code>
            </a>
            <img src="/dir1/images/copycode.svg" style="max-height:24px; cursor: pointer" onclick="copyCode(&#39;service-networking-run-my-nginx-yaml&#39;)" title="Copy service/networking/run-my-nginx.yaml to clipboard"/>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <div class="highlight">
              <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#a2f;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">selector</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">matchLabels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">run</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">2</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">template</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">labels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">run</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">containers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">image</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">ports</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>- <span style="color:#a2f;font-weight:bold">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span></code></pre>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <p>
      This makes it accessible from any node in your cluster. Check the nodes the Pod is running on:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f ./run-my-nginx.yaml
kubectl get pods -l <span style="color:#b8860b">run</span><span style="color:#666">=</span>my-nginx -o wide</code></pre>
    </div>
    <pre><code>NAME                        READY     STATUS    RESTARTS   AGE       IP            NODE
my-nginx-3800858182-jr4a2   1/1       Running   0          13s       10.244.3.4    kubernetes-minion-905m
my-nginx-3800858182-kna2y   1/1       Running   0          13s       10.244.2.5    kubernetes-minion-ljyd</code></pre>
    <p>
      Check your pods’ IPs:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -l <span style="color:#b8860b">run</span><span style="color:#666">=</span>my-nginx -o yaml | grep podIP
    podIP: 10.244.3.4
    podIP: 10.244.2.5</code></pre>
    </div>
    <p>
      You should be able to ssh into any node in your cluster and curl both IPs. Note that the containers are
      <em>
        not
      </em>
      using port 80 on the node, nor are there any special NAT rules to route traffic to the pod. This means you can run multiple nginx pods on the same node all using the same containerPort and access them from any other pod or node in your cluster using IP. Like Docker, ports can still be published to the host node’s interfaces, but the need for this is radically diminished because of the networking model.
    </p>
    <p>
      You can read more about
      <a href="/docs/concepts/cluster-administration/networking/#how-to-achieve-this">
        how we achieve this
      </a>
      if you’re curious.
    </p>
    <h2 id="creating-a-service">
      Creating a Service
    </h2>
    <p>
      So we have pods running nginx in a flat, cluster wide, address space. In theory, you could talk to these pods directly, but what happens when a node dies? The pods die with it, and the Deployment will create new ones, with different IPs. This is the problem a Service solves.
    </p>
    <p>
      A Kubernetes Service is an abstraction which defines a logical set of Pods running somewhere in your cluster, that all provide the same functionality. When created, each Service is assigned a unique IP address (also called clusterIP). This address is tied to the lifespan of the Service, and will not change while the Service is alive. Pods can be configured to talk to the Service, and know that communication to the Service will be automatically load-balanced out to some pod that is a member of the Service.
    </p>
    <p>
      You can create a Service for your 2 nginx replicas with
      <code>
        kubectl expose
      </code>
      :
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl expose deployment/my-nginx</code></pre>
    </div>
    <pre><code>service/my-nginx exposed</code></pre>
    <p>
      This is equivalent to
      <code>
        kubectl apply -f
      </code>
      the following yaml:
    </p>
    <table class="includecode" id="service-networking-nginx-svc-yaml">
      <thead>
        <tr>
          <th>
            <a href="https://raw.githubusercontent.com/kubernetes/website/master/content/en/examples/service/networking/nginx-svc.yaml" download="service/networking/nginx-svc.yaml">
              <code>
                service/networking/nginx-svc.yaml
              </code>
            </a>
            <img src="/dir1/images/copycode.svg" style="max-height:24px; cursor: pointer" onclick="copyCode(&#39;service-networking-nginx-svc-yaml&#39;)" title="Copy service/networking/nginx-svc.yaml to clipboard"/>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <div class="highlight">
              <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#a2f;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Service<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">labels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">run</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">ports</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#a2f;font-weight:bold">port</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">protocol</span>:<span style="color:#bbb"> </span>TCP<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">selector</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">run</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span></code></pre>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <p>
      This specification will create a Service which targets TCP port 80 on any Pod
      with the
      <code>
        run: my-nginx
      </code>
      label, and expose it on an abstracted Service port
      (
      <code>
        targetPort
      </code>
      : is the port the container accepts traffic on,
      <code>
        port
      </code>
      : is the
      abstracted Service port, which can be any port other pods use to access the
      Service).
      View
      <a href="/docs/reference/generated/kubernetes-api/v1.18/#service-v1-core">
        Service
      </a>
      API object to see the list of supported fields in service definition.
      Check your Service:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get svc my-nginx</code></pre>
    </div>
    <pre><code>NAME       TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
my-nginx   ClusterIP   10.0.162.149   &lt;none&gt;        80/TCP    21s</code></pre>
    <p>
      As mentioned previously, a Service is backed by a group of Pods. These Pods are
      exposed through
      <code>
        endpoints
      </code>
      . The Service’s selector will be evaluated continuously
      and the results will be POSTed to an Endpoints object also named
      <code>
        my-nginx
      </code>
      .
      When a Pod dies, it is automatically removed from the endpoints, and new Pods
      matching the Service’s selector will automatically get added to the endpoints.
      Check the endpoints, and note that the IPs are the same as the Pods created in
      the first step:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl describe svc my-nginx</code></pre>
    </div>
    <pre><code>Name:                my-nginx
Namespace:           default
Labels:              run=my-nginx
Annotations:         &lt;none&gt;
Selector:            run=my-nginx
Type:                ClusterIP
IP:                  10.0.162.149
Port:                &lt;unset&gt; 80/TCP
Endpoints:           10.244.2.5:80,10.244.3.4:80
Session Affinity:    None
Events:              &lt;none&gt;</code></pre>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get ep my-nginx</code></pre>
    </div>
    <pre><code>NAME       ENDPOINTS                     AGE
my-nginx   10.244.2.5:80,10.244.3.4:80   1m</code></pre>
    <p>
      You should now be able to curl the nginx Service on
      <code>
        &lt;CLUSTER-IP&gt;:&lt;PORT&gt;
      </code>
      from
      any node in your cluster. Note that the Service IP is completely virtual, it
      never hits the wire. If you’re curious about how this works you can read more
      about the
      <a href="/docs/concepts/services-networking/service/#virtual-ips-and-service-proxies">
        service proxy
      </a>
      .
    </p>
    <h2 id="accessing-the-service">
      Accessing the Service
    </h2>
    <p>
      Kubernetes supports 2 primary modes of finding a Service - environment variables
      and DNS. The former works out of the box while the latter requires the
      <a href="http://releases.k8s.io/master/cluster/addons/dns/coredns">
        CoreDNS cluster addon
      </a>
      .
      </p><blockquote class="note" data-diff="">
        <div>
          <strong>
            Note:
          </strong>
          If the service environment variables are not desired (because possible clashing with expected program ones,
          too many variables to process, only using DNS, etc) you can disable this mode by setting the
          <code>
            enableServiceLinks
          </code>
          flag to
          <code>
            false
          </code>
          on the
          <a href="/docs/reference/generated/kubernetes-api/v1.18/#pod-v1-core">
            pod spec
          </a>
          .
        </div>
      </blockquote>
    <p></p>
    <h3 id="environment-variables">
      Environment Variables
    </h3>
    <p>
      When a Pod runs on a Node, the kubelet adds a set of environment variables for
      each active Service. This introduces an ordering problem. To see why, inspect
      the environment of your running nginx Pods (your Pod name will be different):
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> my-nginx-3800858182-jr4a2 -- printenv | grep SERVICE</code></pre>
    </div>
    <pre><code>KUBERNETES_SERVICE_HOST=10.0.0.1
KUBERNETES_SERVICE_PORT=443
KUBERNETES_SERVICE_PORT_HTTPS=443</code></pre>
    <p>
      Note there’s no mention of your Service. This is because you created the replicas
      before the Service. Another disadvantage of doing this is that the scheduler might
      put both Pods on the same machine, which will take your entire Service down if
      it dies. We can do this the right way by killing the 2 Pods and waiting for the
      Deployment to recreate them. This time around the Service exists
      <em>
        before
      </em>
      the
      replicas. This will give you scheduler-level Service spreading of your Pods
      (provided all your nodes have equal capacity), as well as the right environment
      variables:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl scale deployment my-nginx --replicas<span style="color:#666">=</span>0; kubectl scale deployment my-nginx --replicas<span style="color:#666">=</span>2;

kubectl get pods -l <span style="color:#b8860b">run</span><span style="color:#666">=</span>my-nginx -o wide</code></pre>
    </div>
    <pre><code>NAME                        READY     STATUS    RESTARTS   AGE     IP            NODE
my-nginx-3800858182-e9ihh   1/1       Running   0          5s      10.244.2.7    kubernetes-minion-ljyd
my-nginx-3800858182-j4rm4   1/1       Running   0          5s      10.244.3.8    kubernetes-minion-905m</code></pre>
    <p>
      You may notice that the pods have different names, since they are killed and recreated.
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> my-nginx-3800858182-e9ihh -- printenv | grep SERVICE</code></pre>
    </div>
    <pre><code>KUBERNETES_SERVICE_PORT=443
MY_NGINX_SERVICE_HOST=10.0.162.149
KUBERNETES_SERVICE_HOST=10.0.0.1
MY_NGINX_SERVICE_PORT=80
KUBERNETES_SERVICE_PORT_HTTPS=443</code></pre>
    <h3 id="dns">
      DNS
    </h3>
    <p>
      Kubernetes offers a DNS cluster addon Service that automatically assigns dns names to other Services. You can check if it’s running on your cluster:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get services kube-dns --namespace<span style="color:#666">=</span>kube-system</code></pre>
    </div>
    <pre><code>NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE
kube-dns   ClusterIP   10.0.0.10    &lt;none&gt;        53/UDP,53/TCP   8m</code></pre>
    <p>
      The rest of this section will assume you have a Service with a long lived IP
      (my-nginx), and a DNS server that has assigned a name to that IP. Here we use the CoreDNS cluster addon (application name
      <code>
        kube-dns
      </code>
      ), so you can talk to the Service from any pod in your cluster using standard methods (e.g.
      <code>
        gethostbyname()
      </code>
      ). If CoreDNS isn’t running, you can enable it referring to the
      <a href="https://github.com/coredns/deployment/tree/master/kubernetes">
        CoreDNS README
      </a>
      or
      <a href="/docs/tasks/administer-cluster/coredns/#installing-coredns">
        Installing CoreDNS
      </a>
      . Let’s run another curl application to test this:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl run curl --image<span style="color:#666">=</span>radial/busyboxplus:curl -i --tty</code></pre>
    </div>
    <pre><code>Waiting for pod default/curl-131556218-9fnch to be running, status is Pending, pod ready: false
Hit enter for command prompt</code></pre>
    <p>
      Then, hit enter and run
      <code>
        nslookup my-nginx
      </code>
      :
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#666">[</span> root@curl-131556218-9fnch:/ <span style="color:#666">]</span>$ nslookup my-nginx
Server:    10.0.0.10
Address 1: 10.0.0.10

Name:      my-nginx
Address 1: 10.0.162.149</code></pre>
    </div>
    <h2 id="securing-the-service">
      Securing the Service
    </h2>
    <p>
      Till now we have only accessed the nginx server from within the cluster. Before exposing the Service to the internet, you want to make sure the communication channel is secure. For this, you will need:
    </p>
    <ul>
      <li>
        Self signed certificates for https (unless you already have an identity certificate)
      </li>
      <li>
        An nginx server configured to use the certificates
      </li>
      <li>
        A
        <a href="/docs/concepts/configuration/secret/">
          secret
        </a>
        that makes the certificates accessible to pods
      </li>
    </ul>
    <p>
      You can acquire all these from the
      <a href="https://github.com/kubernetes/examples/tree/master/staging/https-nginx/">
        nginx https example
      </a>
      . This requires having go and make tools installed. If you don’t want to install those, then follow the manual steps later. In short:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">make keys <span style="color:#b8860b">KEY</span><span style="color:#666">=</span>/tmp/nginx.key <span style="color:#b8860b">CERT</span><span style="color:#666">=</span>/tmp/nginx.crt
kubectl create secret tls nginxsecret --key /tmp/nginx.key --cert /tmp/nginx.crt</code></pre>
    </div>
    <pre><code>secret/nginxsecret created</code></pre>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get secrets</code></pre>
    </div>
    <pre><code>NAME                  TYPE                                  DATA      AGE
default-token-il9rc   kubernetes.io/service-account-token   1         1d
nginxsecret           kubernetes.io/tls                     2         1m</code></pre>
    <p>
      And also the configmap:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl create configmap nginxconfigmap --from-file<span style="color:#666">=</span>default.conf</code></pre>
    </div>
    <pre><code>configmap/nginxconfigmap created</code></pre>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get configmaps</code></pre>
    </div>
    <pre><code>NAME             DATA   AGE
nginxconfigmap   1      114s</code></pre>
    <p>
      Following are the manual steps to follow in case you run into problems running make (on windows for example):
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#080;font-style:italic"># Create a public private key pair</span>
openssl req -x509 -nodes -days <span style="color:#666">365</span> -newkey rsa:2048 -keyout /d/tmp/nginx.key -out /d/tmp/nginx.crt -subj <span style="color:#b44">&#34;/CN=my-nginx/O=my-nginx&#34;</span>
<span style="color:#080;font-style:italic"># Convert the keys to base64 encoding</span>
cat /d/tmp/nginx.crt | base64
cat /d/tmp/nginx.key | base64</code></pre>
    </div>
    <p>
      Use the output from the previous commands to create a yaml file as follows. The base64 encoded value should all be on a single line.
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#a2f;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;v1&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">kind</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;Secret&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;nginxsecret&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;default&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">type</span>:<span style="color:#bbb"> </span>kubernetes.io/tls<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">data</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">tls.crt</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURIekNDQWdlZ0F3SUJBZ0lKQUp5M3lQK0pzMlpJTUEwR0NTcUdTSWIzRFFFQkJRVUFNQ1l4RVRBUEJnTlYKQkFNVENHNW5hVzU0YzNaak1SRXdEd1lEVlFRS0V3aHVaMmx1ZUhOMll6QWVGdzB4TnpFd01qWXdOekEzTVRKYQpGdzB4T0RFd01qWXdOekEzTVRKYU1DWXhFVEFQQmdOVkJBTVRDRzVuYVc1NGMzWmpNUkV3RHdZRFZRUUtFd2h1CloybHVlSE4yWXpDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBSjFxSU1SOVdWM0IKMlZIQlRMRmtobDRONXljMEJxYUhIQktMSnJMcy8vdzZhU3hRS29GbHlJSU94NGUrMlN5ajBFcndCLzlYTnBwbQppeW1CL3JkRldkOXg5UWhBQUxCZkVaTmNiV3NsTVFVcnhBZW50VWt1dk1vLzgvMHRpbGhjc3paenJEYVJ4NEo5Ci82UVRtVVI3a0ZTWUpOWTVQZkR3cGc3dlVvaDZmZ1Voam92VG42eHNVR0M2QURVODBpNXFlZWhNeVI1N2lmU2YKNHZpaXdIY3hnL3lZR1JBRS9mRTRqakxCdmdONjc2SU90S01rZXV3R0ljNDFhd05tNnNTSzRqYUNGeGpYSnZaZQp2by9kTlEybHhHWCtKT2l3SEhXbXNhdGp4WTRaNVk3R1ZoK0QrWnYvcW1mMFgvbVY0Rmo1NzV3ajFMWVBocWtsCmdhSXZYRyt4U1FVQ0F3RUFBYU5RTUU0d0hRWURWUjBPQkJZRUZPNG9OWkI3YXc1OUlsYkROMzhIYkduYnhFVjcKTUI4R0ExVWRJd1FZTUJhQUZPNG9OWkI3YXc1OUlsYkROMzhIYkduYnhFVjdNQXdHQTFVZEV3UUZNQU1CQWY4dwpEUVlKS29aSWh2Y05BUUVGQlFBRGdnRUJBRVhTMW9FU0lFaXdyMDhWcVA0K2NwTHI3TW5FMTducDBvMm14alFvCjRGb0RvRjdRZnZqeE04Tzd2TjB0clcxb2pGSW0vWDE4ZnZaL3k4ZzVaWG40Vm8zc3hKVmRBcStNZC9jTStzUGEKNmJjTkNUekZqeFpUV0UrKzE5NS9zb2dmOUZ3VDVDK3U2Q3B5N0M3MTZvUXRUakViV05VdEt4cXI0Nk1OZWNCMApwRFhWZmdWQTRadkR4NFo3S2RiZDY5eXM3OVFHYmg5ZW1PZ05NZFlsSUswSGt0ejF5WU4vbVpmK3FqTkJqbWZjCkNnMnlwbGQ0Wi8rUUNQZjl3SkoybFIrY2FnT0R4elBWcGxNSEcybzgvTHFDdnh6elZPUDUxeXdLZEtxaUMwSVEKQ0I5T2wwWW5scE9UNEh1b2hSUzBPOStlMm9KdFZsNUIyczRpbDlhZ3RTVXFxUlU9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">tls.key</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#34;LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRQ2RhaURFZlZsZHdkbFIKd1V5eFpJWmVEZWNuTkFhbWh4d1NpeWF5N1AvOE9ta3NVQ3FCWmNpQ0RzZUh2dGtzbzlCSzhBZi9WemFhWm9zcApnZjYzUlZuZmNmVUlRQUN3WHhHVFhHMXJKVEVGSzhRSHA3VkpMcnpLUC9QOUxZcFlYTE0yYzZ3MmtjZUNmZitrCkU1bEVlNUJVbUNUV09UM3c4S1lPNzFLSWVuNEZJWTZMMDUrc2JGQmd1Z0ExUE5JdWFubm9UTWtlZTRuMG4rTDQKb3NCM01ZUDhtQmtRQlAzeE9JNHl3YjREZXUraURyU2pKSHJzQmlIT05Xc0RadXJFaXVJMmdoY1kxeWIyWHI2UAozVFVOcGNSbC9pVG9zQngxcHJHclk4V09HZVdPeGxZZmcvbWIvNnBuOUYvNWxlQlkrZStjSTlTMkQ0YXBKWUdpCkwxeHZzVWtGQWdNQkFBRUNnZ0VBZFhCK0xkbk8ySElOTGo5bWRsb25IUGlHWWVzZ294RGQwci9hQ1Zkank4dlEKTjIwL3FQWkUxek1yall6Ry9kVGhTMmMwc0QxaTBXSjdwR1lGb0xtdXlWTjltY0FXUTM5SjM0VHZaU2FFSWZWNgo5TE1jUHhNTmFsNjRLMFRVbUFQZytGam9QSFlhUUxLOERLOUtnNXNrSE5pOWNzMlY5ckd6VWlVZWtBL0RBUlBTClI3L2ZjUFBacDRuRWVBZmI3WTk1R1llb1p5V21SU3VKdlNyblBESGtUdW1vVlVWdkxMRHRzaG9reUxiTWVtN3oKMmJzVmpwSW1GTHJqbGtmQXlpNHg0WjJrV3YyMFRrdWtsZU1jaVlMbjk4QWxiRi9DSmRLM3QraTRoMTVlR2ZQegpoTnh3bk9QdlVTaDR2Q0o3c2Q5TmtEUGJvS2JneVVHOXBYamZhRGR2UVFLQmdRRFFLM01nUkhkQ1pKNVFqZWFKClFGdXF4cHdnNzhZTjQyL1NwenlUYmtGcVFoQWtyczJxWGx1MDZBRzhrZzIzQkswaHkzaE9zSGgxcXRVK3NHZVAKOWRERHBsUWV0ODZsY2FlR3hoc0V0L1R6cEdtNGFKSm5oNzVVaTVGZk9QTDhPTm1FZ3MxMVRhUldhNzZxelRyMgphRlpjQ2pWV1g0YnRSTHVwSkgrMjZnY0FhUUtCZ1FEQmxVSUUzTnNVOFBBZEYvL25sQVB5VWs1T3lDdWc3dmVyClUycXlrdXFzYnBkSi9hODViT1JhM05IVmpVM25uRGpHVHBWaE9JeXg5TEFrc2RwZEFjVmxvcG9HODhXYk9lMTAKMUdqbnkySmdDK3JVWUZiRGtpUGx1K09IYnRnOXFYcGJMSHBzUVpsMGhucDBYSFNYVm9CMUliQndnMGEyOFVadApCbFBtWmc2d1BRS0JnRHVIUVV2SDZHYTNDVUsxNFdmOFhIcFFnMU16M2VvWTBPQm5iSDRvZUZKZmcraEppSXlnCm9RN3hqWldVR3BIc3AyblRtcHErQWlSNzdyRVhsdlhtOElVU2FsbkNiRGlKY01Pc29RdFBZNS9NczJMRm5LQTQKaENmL0pWb2FtZm1nZEN0ZGtFMXNINE9MR2lJVHdEbTRpb0dWZGIwMllnbzFyb2htNUpLMUI3MkpBb0dBUW01UQpHNDhXOTVhL0w1eSt5dCsyZ3YvUHM2VnBvMjZlTzRNQ3lJazJVem9ZWE9IYnNkODJkaC8xT2sybGdHZlI2K3VuCnc1YytZUXRSTHlhQmd3MUtpbGhFZDBKTWU3cGpUSVpnQWJ0LzVPbnlDak9OVXN2aDJjS2lrQ1Z2dTZsZlBjNkQKckliT2ZIaHhxV0RZK2Q1TGN1YSt2NzJ0RkxhenJsSlBsRzlOZHhrQ2dZRUF5elIzT3UyMDNRVVV6bUlCRkwzZAp4Wm5XZ0JLSEo3TnNxcGFWb2RjL0d5aGVycjFDZzE2MmJaSjJDV2RsZkI0VEdtUjZZdmxTZEFOOFRwUWhFbUtKCnFBLzVzdHdxNWd0WGVLOVJmMWxXK29xNThRNTBxMmk1NVdUTThoSDZhTjlaMTltZ0FGdE5VdGNqQUx2dFYxdEYKWSs4WFJkSHJaRnBIWll2NWkwVW1VbGc9Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K&#34;</span></code></pre>
    </div>
    <p>
      Now create the secrets using the file:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f nginxsecrets.yaml
kubectl get secrets</code></pre>
    </div>
    <pre><code>NAME                  TYPE                                  DATA      AGE
default-token-il9rc   kubernetes.io/service-account-token   1         1d
nginxsecret           kubernetes.io/tls                     2         1m</code></pre>
    <p>
      Now modify your nginx replicas to start an https server using the certificate in the secret, and the Service, to expose both ports (80 and 443):
    </p>
    <table class="includecode" id="service-networking-nginx-secure-app-yaml">
      <thead>
        <tr>
          <th>
            <a href="https://raw.githubusercontent.com/kubernetes/website/master/content/en/examples/service/networking/nginx-secure-app.yaml" download="service/networking/nginx-secure-app.yaml">
              <code>
                service/networking/nginx-secure-app.yaml
              </code>
            </a>
            <img src="/dir1/images/copycode.svg" style="max-height:24px; cursor: pointer" onclick="copyCode(&#39;service-networking-nginx-secure-app-yaml&#39;)" title="Copy service/networking/nginx-secure-app.yaml to clipboard"/>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <div class="highlight">
              <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#a2f;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Service<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">labels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">run</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">type</span>:<span style="color:#bbb"> </span>NodePort<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">ports</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#a2f;font-weight:bold">port</span>:<span style="color:#bbb"> </span><span style="color:#666">8080</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">targetPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">protocol</span>:<span style="color:#bbb"> </span>TCP<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>http<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#a2f;font-weight:bold">port</span>:<span style="color:#bbb"> </span><span style="color:#666">443</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">protocol</span>:<span style="color:#bbb"> </span>TCP<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>https<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">selector</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">run</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span><span style="color:#bbb"></span>---<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">selector</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">matchLabels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">run</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">template</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">labels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">run</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>secret-volume<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">secret</span>:<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">secretName</span>:<span style="color:#bbb"> </span>nginxsecret<span style="color:#bbb">
</span><span style="color:#bbb">      </span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>configmap-volume<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">configMap</span>:<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>nginxconfigmap<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">containers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>nginxhttps<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">image</span>:<span style="color:#bbb"> </span>bprashanth/nginxhttps:<span style="color:#666">1.0</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">ports</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>- <span style="color:#a2f;font-weight:bold">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">443</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span>- <span style="color:#a2f;font-weight:bold">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#666">80</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">volumeMounts</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>- <span style="color:#a2f;font-weight:bold">mountPath</span>:<span style="color:#bbb"> </span>/etc/nginx/ssl<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>secret-volume<span style="color:#bbb">
</span><span style="color:#bbb">        </span>- <span style="color:#a2f;font-weight:bold">mountPath</span>:<span style="color:#bbb"> </span>/etc/nginx/conf.d<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>configmap-volume<span style="color:#bbb">
</span></code></pre>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <p>
      Noteworthy points about the nginx-secure-app manifest:
    </p>
    <ul>
      <li>
        It contains both Deployment and Service specification in the same file.
      </li>
      <li>
        The
        <a href="https://github.com/kubernetes/examples/tree/master/staging/https-nginx/default.conf">
          nginx server
        </a>
        serves HTTP traffic on port 80 and HTTPS traffic on 443, and nginx Service
        exposes both ports.
      </li>
      <li>
        <p>
          Each container has access to the keys through a volume mounted at
          <code>
            /etc/nginx/ssl
          </code>
          .
          This is setup
          <em>
            before
          </em>
          the nginx server is started.
        </p>
        <div class="highlight">
          <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl delete deployments,svc my-nginx; kubectl create -f ./nginx-secure-app.yaml</code></pre>
        </div>
      </li>
    </ul>
    <p>
      At this point you can reach the nginx server from any node.
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get pods -o yaml | grep -i podip
    podIP: 10.244.3.5
node $ curl -k https://10.244.3.5
...
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</code></pre>
    </div>
    <p>
      Note how we supplied the
      <code>
        -k
      </code>
      parameter to curl in the last step, this is because we don’t know anything about the pods running nginx at certificate generation time,
      so we have to tell curl to ignore the CName mismatch. By creating a Service we linked the CName used in the certificate with the actual DNS name used by pods during Service lookup.
      Let’s test this from a pod (the same secret is being reused for simplicity, the pod only needs nginx.crt to access the Service):
    </p>
    <table class="includecode" id="service-networking-curlpod-yaml">
      <thead>
        <tr>
          <th>
            <a href="https://raw.githubusercontent.com/kubernetes/website/master/content/en/examples/service/networking/curlpod.yaml" download="service/networking/curlpod.yaml">
              <code>
                service/networking/curlpod.yaml
              </code>
            </a>
            <img src="/dir1/images/copycode.svg" style="max-height:24px; cursor: pointer" onclick="copyCode(&#39;service-networking-curlpod-yaml&#39;)" title="Copy service/networking/curlpod.yaml to clipboard"/>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <div class="highlight">
              <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#a2f;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>curl-deployment<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a2f;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">selector</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">matchLabels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">app</span>:<span style="color:#bbb"> </span>curlpod<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">template</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">labels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">app</span>:<span style="color:#bbb"> </span>curlpod<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#a2f;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>secret-volume<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">secret</span>:<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">secretName</span>:<span style="color:#bbb"> </span>nginxsecret<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#a2f;font-weight:bold">containers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>- <span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>curlpod<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">command</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>- sh<span style="color:#bbb">
</span><span style="color:#bbb">        </span>- -c<span style="color:#bbb">
</span><span style="color:#bbb">        </span>- while<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">true</span>;<span style="color:#bbb"> </span>do<span style="color:#bbb"> </span>sleep<span style="color:#bbb"> </span><span style="color:#666">1</span>;<span style="color:#bbb"> </span>done<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">image</span>:<span style="color:#bbb"> </span>radial/busyboxplus:curl<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#a2f;font-weight:bold">volumeMounts</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>- <span style="color:#a2f;font-weight:bold">mountPath</span>:<span style="color:#bbb"> </span>/etc/nginx/ssl<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#a2f;font-weight:bold">name</span>:<span style="color:#bbb"> </span>secret-volume<span style="color:#bbb">
</span></code></pre>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f ./curlpod.yaml
kubectl get pods -l <span style="color:#b8860b">app</span><span style="color:#666">=</span>curlpod</code></pre>
    </div>
    <pre><code>NAME                               READY     STATUS    RESTARTS   AGE
curl-deployment-1515033274-1410r   1/1       Running   0          1m</code></pre>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl <span style="color:#a2f">exec</span> curl-deployment-1515033274-1410r -- curl https://my-nginx --cacert /etc/nginx/ssl/tls.crt
...
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
...</code></pre>
    </div>
    <h2 id="exposing-the-service">
      Exposing the Service
    </h2>
    <p>
      For some parts of your applications you may want to expose a Service onto an
      external IP address. Kubernetes supports two ways of doing this: NodePorts and
      LoadBalancers. The Service created in the last section already used
      <code>
        NodePort
      </code>
      ,
      so your nginx HTTPS replica is ready to serve traffic on the internet if your
      node has a public IP.
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get svc my-nginx -o yaml | grep nodePort -C <span style="color:#666">5</span>
  uid: 07191fb3-f61a-11e5-8ae5-42010af00002
spec:
  clusterIP: 10.0.162.149
  ports:
  - name: http
    nodePort: <span style="color:#666">31704</span>
    port: <span style="color:#666">8080</span>
    protocol: TCP
    targetPort: <span style="color:#666">80</span>
  - name: https
    nodePort: <span style="color:#666">32453</span>
    port: <span style="color:#666">443</span>
    protocol: TCP
    targetPort: <span style="color:#666">443</span>
  selector:
    run: my-nginx</code></pre>
    </div>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get nodes -o yaml | grep ExternalIP -C <span style="color:#666">1</span>
    - address: 104.197.41.11
      type: ExternalIP
    allocatable:
--
    - address: 23.251.152.56
      type: ExternalIP
    allocatable:
...

$ curl https://&lt;EXTERNAL-IP&gt;:&lt;NODE-PORT&gt; -k
...
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</code></pre>
    </div>
    <p>
      Let’s now recreate the Service to use a cloud load balancer, just change the
      <code>
        Type
      </code>
      of
      <code>
        my-nginx
      </code>
      Service from
      <code>
        NodePort
      </code>
      to
      <code>
        LoadBalancer
      </code>
      :
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl edit svc my-nginx
kubectl get svc my-nginx</code></pre>
    </div>
    <pre><code>NAME       TYPE        CLUSTER-IP     EXTERNAL-IP        PORT(S)               AGE
my-nginx   ClusterIP   10.0.162.149   162.222.184.144    80/TCP,81/TCP,82/TCP  21s</code></pre>
    <pre><code>curl https://&lt;EXTERNAL-IP&gt; -k
...
&lt;title&gt;Welcome to nginx!&lt;/title&gt;</code></pre>
    <p>
      The IP address in the
      <code>
        EXTERNAL-IP
      </code>
      column is the one that is available on the public internet.  The
      <code>
        CLUSTER-IP
      </code>
      is only available inside your
      cluster/private cloud network.
    </p>
    <p>
      Note that on AWS, type
      <code>
        LoadBalancer
      </code>
      creates an ELB, which uses a (long)
      hostname, not an IP.  It’s too long to fit in the standard
      <code>
        kubectl get svc
      </code>
      output, in fact, so you’ll need to do
      <code>
        kubectl describe service my-nginx
      </code>
      to
      see it.  You’ll see something like this:
    </p>
    <div class="highlight">
      <pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl describe service my-nginx
...
LoadBalancer Ingress:   a320587ffd19711e5a37606cf4a74574-1142138393.us-east-1.elb.amazonaws.com
...</code></pre>
    </div>
    <h2 id="what-s-next">
      What&#39;s next
    </h2>
    <ul>
      <li>
        Learn more about
        <a href="/docs/tasks/access-application-cluster/service-access-application-cluster/">
          Using a Service to Access an Application in a Cluster
        </a>
      </li>
      <li>
        Learn more about
        <a href="/docs/tasks/access-application-cluster/connecting-frontend-backend/">
          Connecting a Front End to a Back End Using a Service
        </a>
      </li>
      <li>
        Learn more about
        <a href="/docs/tasks/access-application-cluster/create-external-load-balancer/">
          Creating an External Load Balancer
        </a>
      </li>
    </ul>
  
</body></html>